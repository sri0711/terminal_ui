name: Rust AI Optimizer

on:
  pull_request: # triggers for PRs to any branch
  workflow_dispatch:

jobs:
  rust-ai-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Install Rust
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # Install Clippy & Rustfmt
      - name: Install Components
        run: rustup component add clippy rustfmt

      # Run Clippy
      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      # Run Rustfmt
      - name: Run Rustfmt
        run: cargo fmt --all -- --check

      # Get PR diff (dynamic base branch)
      - name: Get PR diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr.diff

      # Run AI Suggestion
      - name: AI Optimization Suggestion
        run: |
          git clone https://github.com/ggerganov/llama.cpp
          cd llama.cpp
          mkdir build && cd build
          cmake ..
          make
          ../main -m ../models/ggml-model.bin -p "Analyze this Rust diff and suggest optimized code with exact changes:" < ../../pr.diff > ../../ai_suggestions.txt

      # Comment on PR
      - name: Post AI Suggestions as PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: ai_suggestions.txt
